// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  password           String   // Will be hashed with bcrypt
  name               String
  role               String   // "Unit Leader", "Team Lead", "Member"
  organizationalUnit String?  // ID of the unit they belong to
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  // Relationships
  createdProjects          Project[]                      @relation("ProjectCreator")
  createdObjectives        Objective[]                    @relation("ObjectiveCreator")
  createdWorkItems         WorkItem[]                     @relation("WorkItemCreator")
  refinementSessions       RefinementSession[]            @relation("SessionCreator")
  discussionMessages       DiscussionMessage[]
  completedRefinements     RefinementUnitCompletion[]     @relation("CompletedRefinements")
  
  @@map("users")
}

// ============================================
// ORGANIZATIONAL STRUCTURE
// ============================================

model OrganizationalUnit {
  id          String   @id @default(cuid())
  name        String
  parentId    String?  // null for root units
  tier        Int      @default(1) // 1 = top level, 2 = second level, 3 = third level
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Self-referential relationship for hierarchy
  parent      OrganizationalUnit?  @relation("UnitHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    OrganizationalUnit[] @relation("UnitHierarchy")
  
  // Relationships
  projects                Project[]                      @relation
  objectives              ObjectiveAssignment[]
  completedObjectives     ObjectiveCompletion[]          @relation("CompletedObjectives")
  refinementCompletions   RefinementUnitCompletion[]     @relation("RefinementCompletions")
  throughputHistory       TeamThroughput[]
  
  @@map("organizational_units")
}

// ============================================
// PROJECT MANAGEMENT
// ============================================

model Project {
  id          String   @id @default(cuid())
  title       String
  description String?
  owner       String?  // Name of project owner/sponsor
  ownerUnit   String   // ID of owning organizational unit
  ownerTier   Int      // Tier level (1, 2, 3, etc.)
  status      String   @default("Planning") // Planning, In Progress, At Risk, Completed
  startDate   String   // Stored as string for simplicity
  targetDate  String
  budget      Float    @default(0)
  notes       String?
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  creator         User                  @relation("ProjectCreator", fields: [createdBy], references: [id])
  owningUnit      OrganizationalUnit    @relation(fields: [ownerUnit], references: [id])
  objectives      Objective[]
  refinementSessions RefinementSession[]
  risks           Risk[]
  
  @@map("projects")
}

model Objective {
  id                  String   @id @default(cuid())
  title               String
  description         String?
  targetDate          String
  projectId           String
  fromTier            Int      // Which tier created this objective
  parentObjectiveId   String?  // Link to parent objective if this was refined from another
  createdBy           String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relationships
  project             Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator             User                   @relation("ObjectiveCreator", fields: [createdBy], references: [id])
  parentObjective     Objective?             @relation("ObjectiveHierarchy", fields: [parentObjectiveId], references: [id], onDelete: SetNull)
  childObjectives     Objective[]            @relation("ObjectiveHierarchy")
  assignedUnits       ObjectiveAssignment[]
  completedByUnits    ObjectiveCompletion[]
  refinementSessions  RefinementSession[]
  risks               Risk[]
  
  @@map("objectives")
}

// Junction table for many-to-many relationship between Objectives and Units
model ObjectiveAssignment {
  id         String   @id @default(cuid())
  objectiveId String
  unitId     String
  assignedAt DateTime @default(now())
  
  objective  Objective          @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  unit       OrganizationalUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  @@unique([objectiveId, unitId])
  @@map("objective_assignments")
}

// Track which units have completed refining an objective
model ObjectiveCompletion {
  id          String   @id @default(cuid())
  objectiveId String
  unitId      String
  completedAt DateTime @default(now())
  
  objective   Objective          @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  unit        OrganizationalUnit @relation("CompletedObjectives", fields: [unitId], references: [id], onDelete: Cascade)
  
  @@unique([objectiveId, unitId])
  @@map("objective_completions")
}

model Risk {
  id          String   @id @default(cuid())
  description String
  projectId   String?
  objectiveId String?
  createdAt   DateTime @default(now())
  
  project     Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  objective   Objective? @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  
  @@map("risks")
}

// ============================================
// REFINEMENT SESSIONS
// ============================================

model RefinementSession {
  id                     String   @id @default(cuid())
  projectId              String
  objectiveId            String   // Required - each session is for one objective
  status                 String   @default("in-progress") // not-started, in-progress, completed, escalated
  createdBy              String
  createdAt              DateTime @default(now())
  completedAt            DateTime?
  updatedAt              DateTime @updatedAt
  
  // Relationships
  project                Project                      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  objective              Objective                    @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  creator                User                         @relation("SessionCreator", fields: [createdBy], references: [id])
  workItems              WorkItem[]
  discussionMessages     DiscussionMessage[]
  unitCompletions        RefinementUnitCompletion[]
  
  @@unique([projectId, objectiveId])
  @@map("refinement_sessions")
}

// Track which units have completed their refinement
model RefinementUnitCompletion {
  id                     String   @id @default(cuid())
  refinementSessionId    String
  organizationalUnitId   String
  completedBy            String
  completedAt            DateTime @default(now())
  
  refinementSession      RefinementSession  @relation(fields: [refinementSessionId], references: [id], onDelete: Cascade)
  organizationalUnit     OrganizationalUnit @relation("RefinementCompletions", fields: [organizationalUnitId], references: [id], onDelete: Cascade)
  completedByUser        User               @relation("CompletedRefinements", fields: [completedBy], references: [id])
  
  @@unique([refinementSessionId, organizationalUnitId])
  @@map("refinement_unit_completions")
}

// Work items created during team-level refinement
model WorkItem {
  id                  String    @id @default(cuid())
  refinementSessionId String?   // Optional - work items can exist independently
  title               String
  description         String?
  type                String    @default("Work Item") // Always "Work Item" - simplified from Story/Bug/Task
  priority            String    @default("P3") // P1, P2, P3
  stackRank           Int       @default(0) // Order within priority bucket (lower = higher priority)
  status              String    @default("Backlog") // Backlog, Ready, In Progress, Review, Done
  estimatedEffort     Float?    // Optional story points (not required for forecasting)
  assignedOrgUnit     String    // REQUIRED - All work items must be assigned to a leaf unit
  assignedTo          String?   // Individual assignment
  createdBy           String
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  completedAt         DateTime? // When work item reached "Done" status
  
  refinementSession   RefinementSession? @relation(fields: [refinementSessionId], references: [id], onDelete: Cascade)
  creator             User               @relation("WorkItemCreator", fields: [createdBy], references: [id])
  
  @@map("work_items")
}

// Track team throughput over time for forecasting
model TeamThroughput {
  id              String   @id @default(cuid())
  teamId          String   // Organizational unit ID
  weekStartDate   DateTime // Start of the week (Monday)
  itemsCompleted  Int      @default(0) // Number of items completed this week
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  team            OrganizationalUnit @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, weekStartDate])
  @@map("team_throughput")
}

// Collaboration/discussion messages in refinement sessions
model DiscussionMessage {
  id                  String   @id @default(cuid())
  refinementSessionId String
  authorId            String
  content             String
  createdAt           DateTime @default(now())
  
  refinementSession   RefinementSession @relation(fields: [refinementSessionId], references: [id], onDelete: Cascade)
  author              User              @relation(fields: [authorId], references: [id])
  
  @@map("discussion_messages")
}

